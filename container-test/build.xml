<?xml version="1.0"?>

<project name="Container Test UrlRewrite" default="container-tests" basedir=".">

    <!-- Give user a chance to override without editing this file (and without typing -D each time) -->
    <property file="${user.home}/urlrewrite.build.properties"/>
    <property file="${user.home}/build.properties"/>
    <property file="../build.properties"/>

    <property name="container.port" value="9090"/>

    <property name="target.dir" location="target"/>
    <property name="report.dir" location="reports"/>

    <property name="build.java.dir" location="../build/java"/>
    <property name="build.test.dir" location="../build/test"/>


    <!--
        paths etc
    -->

    <path id="test.classpath">
        <fileset dir="../lib/">
            <include name="*.jar"/>
        </fileset>
        <path path="${build.java.dir}"/>
        <path path="${build.test.dir}"/>
    </path>

    <taskdef resource="cargo.tasks">
        <classpath>
            <pathelement location="lib/cargo-ant-0.9.jar"/>
            <pathelement location="lib/cargo-core-uberjar-0.9.jar"/>
        </classpath>
    </taskdef>


    <!--
       tasks
    -->

    <target name="clean" description="Clean all generated files">
        <delete dir="${target.dir}"/>
        <delete dir="${report.dir}"/>
    </target>

    <target name="compile" depends="clean">
        <ant dir="../" target="compile-test"/>
    </target>

    <target name="war" depends="compile" description="Generate the runtime war">
        <mkdir dir="${target.dir}"/>
        <war warfile="${target.dir}/webapp.war" webxml="webapp/WEB-INF/web.xml">
            <fileset dir="webapp">
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
            <classes dir="${build.java.dir}"/>
            <classes dir="${build.test.dir}"/>
        </war>
        <war warfile="${target.dir}/webapp-mod-style.war" webxml="webapp-mod-style/WEB-INF/web.xml">
            <fileset dir="webapp-mod-style">
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
            <classes dir="${build.java.dir}"/>
            <classes dir="${build.test.dir}"/>
        </war>
    </target>

    <target name="container-tests" depends="war" description="Run the tests on the defined containers">
        <mkdir dir="${report.dir}"/>
        <echo file="${report.dir}/index.html"><![CDATA[
            <html>
            <head><title>Container Test Results</title></head>
            <body>
            <h1>Container Test Results</h1>
            <ul>
        ]]></echo>

        <containerTest id="tomcat-5.5.23" containerid="tomcat5x"
                       installurl="http://www.ibiblio.org/pub/mirrors/apache/tomcat/tomcat-5/v5.5.26/bin/apache-tomcat-5.5.26.zip"/>
        <containerTest id="resin-3.1.6" containerid="resin3x"
                       installurl="http://www.caucho.com/download/resin-3.1.6.zip"/>
        <containerTest id="jetty-6.1.11" containerid="jetty6x"
                       installurl="http://dist.codehaus.org/jetty/jetty-6.1.11/jetty-6.1.11.zip"/>
        <containerTest id="jboss-4.2.3.GA" containerid="jboss4x"
                       installurl="http://voxel.dl.sourceforge.net/sourceforge/jboss/jboss-4.2.3.GA.zip"/>
        <containerTest id="orion2.0.7" containerid="orion2x"
                       installurl="http://www.orionserver.com/distributions/orion2.0.7.zip"/>

        <echo append="true" file="${report.dir}/index.html"><![CDATA[
            </ul>
            </body>
            </html>
        ]]></echo>
    </target>


    <!--
        macros
    -->

    <macrodef name="containerTest">
        <attribute name="id"/>
        <attribute name="containerid"/>
        <attribute name="installurl"/>
        <sequential>
            <echo>Running test for @{id}</echo>

            <cargo id="@{id}" containerId="@{containerid}" action="start" wait="false" log="${target.dir}/log.log">
                <zipUrlInstaller installUrl="@{installurl}">
                    <proxy host="proxy" port="8080"/>
                </zipUrlInstaller>
                <configuration>
                    <property name="cargo.servlet.port" value="${container.port}"/>
                    <deployable type="war" file="${target.dir}/webapp.war"/>
                </configuration>
            </cargo>

            <mkdir dir="${target.dir}/@{id}"/>
            <mkdir dir="${report.dir}/@{id}"/>
            <junit printsummary="yes" fork="true">
                <classpath refid="test.classpath"/>
                <formatter type="xml"/>
                <sysproperty key="test.base.url" value="http://localhost:${container.port}/webapp"/>
                <batchtest todir="${target.dir}/@{id}">
                    <fileset dir="../build/test">
                        <include name="**/container/*.class"/>
                    </fileset>
                </batchtest>
            </junit>
            <junitreport>
                <fileset dir="${target.dir}" includes="@{id}/TEST-*.xml"/>
                <report todir="${report.dir}/@{id}"/>
            </junitreport>

            <cargo refId="@{id}" action="stop"/>

            <echo append="true" file="${report.dir}/index.html"><![CDATA[
                <a href="@{id}/index.html">@{id}</a>
            ]]></echo>
        </sequential>
    </macrodef>

</project>
